{% extends "base2.html" %}

{% block title %}Show Balance{% endblock %}

{% block body %}

	<div class="container">
		<div class="col-md-10 mx-auto">
			<div class="shadow-lg app-description p-3">
				<h2 class="pl-3">Przeglądanie bilansu</h2>
				<div class="row px-3 my-3">
					<div class="ml-lg-auto">
						<label for="checkDate">Wybierz okres:</label>
					</div>	
					<div class="col-6 col-lg-4 col-xl-3">
					
						<form method="post" id="balanceForm" action="/profile/showBalance">
							<select id="selectDate" name="selectDate" class="form-control">
								<option value="1" {{ option1 }}>Bieżący miesiąc</option>
								<option value="2" {{ option2 }}>Poprzedni miesiąc</option>
								<option value="3" {{ option3 }}>Bieżący rok</option>
								<option value="4" {{ option4 }} data-toggle="modal" data-target="#myModal">Niestandardowy</option>
							</select>	
						</form>
						
					</div>
				</div>

				<div class="row px-3">	
					<div class="col-lg-6">
						<fieldset class="shadow-xl rounded-xl p-3 my-3">
							<h3>Przychody</h3>
							<p id="incomes" style="font-size: 15px;"></p>
							
							{% if balance.incomes %}
								<table class="table table-striped table-bordered">
									<thead>
										<tr>
											<th>Income</th>
											<th>Amount</th>
										</tr>
									</thead>
									<tbody>
										{% for income in balance.incomes %}
											<tr>
												<td>{{ income['name'] }}</td>
												<td>{{ income['amount']}}</td>
											</tr>
										{% endfor %}
									</tbody>
								</table>
							{% else %}
								<p>Brak przychodów!</p>
							{% endif %}
							<b>Sum of incomes: {{ balance.sumOfIncomes }}</b>
						</fieldset>
					</div>
					
					<div class="col-lg-6">
						<fieldset class="shadow-xl rounded-xl p-3 my-3">
							<h3>Wydatki</h3>
							<p id="expenses" style="font-size: 15px;"></p>
							
							{% if balance.expenses %}
								<table class="table table-striped table-bordered">
									<thead>
										<tr>
											<th>Expense</th>
											<th>Amount</th>
										</tr>
									</thead>
									<tbody>
										{% for expense in balance.expenses %}
											<tr>
												<td>{{ expense['name'] }}</td>
												<td>{{ expense['amount']}}</td>
											</tr>
										{% endfor %}
									</tbody>
								</table>
							{% else %}
								<p>Brak wydatków!</p>
							{% endif %}
							<b>Sum of expenses: {{ balance.sumOfExpenses }}</b>
						</fieldset>
					</div>
				</div>
				
				{% if balance.sumOfIncomes - balance.sumOfExpenses >= 0 %}
					<div class="alert alert-success text-center">
				{% else %}
					<div class="alert alert-dark text-center">
				{% endif %}
				
					<b>General balance: {{ balance.sumOfIncomes - balance.sumOfExpenses }}</b>
					
				{% if balance.sumOfIncomes > balance.sumOfExpenses %}
					<p>Congratulations, you are a great financial manager!</p>
				{% else %}
					<p>Be careful, you run into debt!</p>
				{% endif %}
				</div>
				
				<div class="row my-3 pt-3" id="chart-parent">
					<canvas id="chart" width="200" height="100"></canvas>
				</div>
			</div>
		</div>
	</div>
		
			<!-- Modal -->
	<div class="modal fade" id="myModal" role="dialog">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title" id="myModalLabel">Podaj okres do wyświetlenia</h4>
					<button type="button" class="close btn-close" data-dismiss="modal">&times;</button>					
				</div>
				
				<form id="modalForm" method="post" action="/profile/showBalance">
				
					<div class="modal-body">
						<div class="row mb-3">
							<div class="pl-3 mt-1">
								<label for="date">Data od:</label>
							</div>	
							<div class="col-8">
								<input type="text" id="startDate" name="startDate" class="form-control"/>
							</div>
						</div>
							
						<input type="hidden" name="selectDate" value="4" />
						
						<div class="row">
							<div class="pl-3 mt-1">
								<label for="date">Data do:</label>
							</div>	
							<div class="col-8">
								<input type="text" id="endDate" name="endDate" class="form-control"/>
							</div>
						</div>
						
						<div id ="errorDate" class="error pl-5 ml-4"></div>
						
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary" id="btn-show-balance">Pokaż</button>
						<button type="button" class="btn btn-danger btn-close" data-dismiss="modal">Zamknij</button>
					</div>
					
				</form>
				
			</div>
		</div>
	</div>
	
	
	<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
	<script>
		var option = $('#selectDate').val();

		$(document).ready(function() {
			
			$('#selectDate').change(function() {
			
				if ($(this).val() == 4) {
					$('#errorDate').text('');
					$('#myModal').modal({backdrop: 'static'},"show");
					
					$('#btn-show-balance').click(function() {
					
						$.post("/profile/checkDates", {
							startDate: $('#startDate').val(), endDate: $('#endDate').val()
							},
							function(data) {
							
								if (data == 'true') {
									$('#myModal').modal("hide");
									$('#modalForm').submit();
								} else {
									$('#errorDate').text('Invalid Date!');
								}
							});
					});
				} else {
					$('#balanceForm').submit();
				}
			});
		});
		
		$('.btn-close').click(function() {
			$('#selectDate').val(option);
		});
		
		function createChart(chartLabels, chartValues) {
			new Chart($('#chart'), {
				type: 'pie',
				data: {
					labels: chartLabels,
					datasets: [{
						data: chartValues,
						backgroundColor: [
							'rgba(255, 99, 132, 0.5)',
							'rgba(54, 162, 235, 0.5)',
							'rgba(255, 206, 86, 0.5)',
							'rgba(75, 192, 192, 0.5)',
							'rgba(153, 102, 255, 0.5)',
							'rgba(255, 159, 64, 0.5)'
						],
						borderColor: [
							'rgba(255, 99, 132, 1)',
							'rgba(54, 162, 235, 1)',
							'rgba(255, 206, 86, 1)',
							'rgba(75, 192, 192, 1)',
							'rgba(153, 102, 255, 1)',
							'rgba(255, 159, 64, 1)'
						],
						borderWidth: 1
					}]
				},
				options: {
					title: {
						display: true,
						text: 'Twoje wydatki',
						fontSize: 20
					}
				}
			});	
		}
		
		function showChart(chartData = []) {
			var chartLabels = [] ;
			var chartValues = [];
				
			for (i in chartData) {
				chartLabels.push(chartData[i].name);
				chartValues.push(chartData[i].amount);
			}
			
			$('#chart').remove();
			$('#chart-parent').append('<canvas id="chart" width="200" height="80"></canvas>');
			if (chartData.length <= 0) {
				chartLabels.push('Brak wydatków');
				chartValues.push('100');
			}
			createChart(chartLabels, chartValues);
		};
		
		showChart();
		
	</script>
{% endblock %}
